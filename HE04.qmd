---
title: "Hands-on Exercise 4"
author: "Teong Sze Ching"
date: "February 1, 2026"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
  freeze: true
---

# Lesson 4-A: Visualizing Distribution

## 1.0 Getting Started

Install and launch the following R packages

```{r}
pacman::p_load(ggdist, ggridges, ggthemes, colorspace, tidyverse)
```

## 2.0 Data

Loading the data to the R environment by using read_csv() function of readr package

```{r}
exam <- read_csv("chap04/data/Exam_data.csv")
```

The data in the file includes (1)Year end examination grades of a cohort of primary 3 students from a local school. (2) There are a total of seven attributes. Four of them are categorical data type and the other three are in continuous data type. The categorical attributes are: ID, CLASS, GENDER and RACE. The continuous attributes are: MATHS, ENGLISH and SCIENCE.

## 3.0 Visualising Distribution with Ridgeline Plot

### 3.1 Plotting ridgeline graph: ggridges method

```{r}
ggplot(exam, aes(x = ENGLISH, y = CLASS)) + geom_density_ridges(scale=3, rel_min_height = 0.01, bandwidth = 3.4, fill = lighten("#7097BB", .3), color = "white") + scale_x_continuous(name = "English grades", expand = c(0, 0)) +  scale_y_discrete(name = NULL, expand = expansion(add = c(0.2, 2.6))) + theme_ridges()
```

### 3.2 Varying fill colors along the x axis
```{r}
ggplot(exam, aes(x = ENGLISH, y = CLASS, fill = stat(x))) + geom_density_ridges_gradient(scale=3, rel_min_height = 0.01) + scale_fill_viridis_c(name="Temp. [F]", option="C") + scale_x_continuous(name = "English grades", expand = c(0, 0)) +  scale_y_discrete(name = NULL, expand = expansion(add = c(0.2, 2.6))) + theme_ridges()
```

### 3.3 Mapping the probabilities directly onto colour
```{r}
ggplot(exam, aes(x = ENGLISH, y = CLASS, fill = 0.5 - abs(0.5-stat(ecdf)))) + stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE) + scale_fill_viridis_c(name = "Tail probability", direction = -1) + theme_ridges()
```

### 3.4 Ridgeline plots with quantile lines
```{r}
ggplot(exam, aes(x = ENGLISH, y = CLASS, fill = factor(stat(quantile)))) + stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, quantiles = 4, quantile_lines = TRUE)  + scale_fill_viridis_d(name = "Quartiles") + theme_ridges()
```

```{r}
ggplot(exam, aes(x = ENGLISH, y = CLASS, fill = factor(stat(quantile)))) + stat_density_ridges(geom = "density_ridges_gradient", calc_ecdf = TRUE, quantiles = c(0.025, 0.975))  + scale_fill_manual(name = "Probability", values = c("#FF0000A0", "#A0A0A0A0", "#0000FFA0"), labels = c("(0, 0.025]", "(0.025, 0.975]", "(0.975, 1]")) + theme_ridges()
```

## 4.0 Visualising Distribution with Raincloud Plot

### 4.1 Plotting a Half Eye graph

```{r}
ggplot(exam, aes(x = RACE, y = ENGLISH)) + stat_halfeye(adjust = 0.5, justification = -0.2, .width = 0, point_colour = NA)
```

### 4.2 Adding the boxplot with geom_boxplot()

```{r}
ggplot(exam, aes(x = RACE, y = ENGLISH)) + stat_halfeye(adjust = 0.5, justification = -0.2, .width = 0, point_colour = NA) + geom_boxplot(width = .20, outlier.shape = NA)
```

### 4.3 Adding the Dot Plots with stat_dots()

```{r}
ggplot(exam, aes(x = RACE, y = ENGLISH)) + stat_halfeye(adjust = 0.5, justification = -0.2, .width = 0, point_colour = NA) + geom_boxplot(width = .20, outlier.shape = NA) + stat_dots(side = "left", justification = 1.2, binwidth = .5, dotsize = 2)
```

### 4.4 Finishing touch..

```{r}
ggplot(exam, aes(x = RACE, y = ENGLISH)) + stat_halfeye(adjust = 0.5, justification = -0.2, .width = 0, point_colour = NA) + geom_boxplot(width = .20, outlier.shape = NA) + stat_dots(side = "left", justification = 1.2, binwidth = .5, dotsize = 1.5)+  coord_flip() +  theme_economist()
```

# Lesson 4-B: Visual Statistical Analysis

## 1.0 Getting Started

Install and launch the following R packages

```{r}
pacman::p_load(ggstatsplot, tidyverse)
```

## 2.0 Data

Loading the data to the R environment by using read_csv() function of readr package

```{r}
exam <- read_csv("chap04/data/Exam_data.csv")
```

The data in the file includes (1)Year end examination grades of a cohort of primary 3 students from a local school. (2) There are a total of seven attributes. Four of them are categorical data type and the other three are in continuous data type. The categorical attributes are: ID, CLASS, GENDER and RACE. The continuous attributes are: MATHS, ENGLISH and SCIENCE.

## 3.0 One-sample test: gghistostats() method

```{r}
set.seed(1234)

gghistostats( data = exam, x = ENGLISH, type = "bayes", test.value = 60, xlab = "English scores")
```

## 3.1 Two-sample mean test: ggbetweenstats()

```{r}
ggbetweenstats(data = exam, x = GENDER, y = MATHS, type = "np", messages = FALSE)
```

## 3.2 Oneway ANOVA Test: ggbetweenstats() method

```{r}
ggbetweenstats(data = exam, x = RACE, y = ENGLISH, type = "p", mean.ci = TRUE, pairwise.comparisons = TRUE, pairwise.display = "s", p.adjust.method = "fdr", messages = FALSE)
```

## 3.3 Significant Test of Correlation: ggscatterstats()

```{r}
ggscatterstats(data = exam, x = MATHS, y = ENGLISH, marginal = FALSE, )
```

## 3.4 Significant Test of Association (Depedence) : ggbarstats() methods

```{r}
exam1 <- exam %>% mutate(MATHS_bins = cut(MATHS, breaks = c(0,60,75,85,100)))
```

```{r}
ggbarstats(exam1,x = MATHS_bins, y = GENDER)
```

# Lesson 4-C: Visualising Uncertainty

## 1.0 Getting Started

Install and launch the following R packages

```{r}
pacman::p_load(plotly, crosstalk, DT, ggdist, ggridges, colorspace,
gganimate, tidyverse)
```

## 2.0 Data

Loading the data to the R environment by using read_csv() function of readr package

```{r}
exam <- read_csv("chap04/data/Exam_data.csv")
```

The data in the file includes (1)Year end examination grades of a cohort of primary 3 students from a local school. (2) There are a total of seven attributes. Four of them are categorical data type and the other three are in continuous data type. The categorical attributes are: ID, CLASS, GENDER and RACE. The continuous attributes are: MATHS, ENGLISH and SCIENCE.

## 3.0 Visualizing the uncertainty of point estimates: ggplot2 methods

```{r}
my_sum <- exam %>% group_by(RACE) %>% summarise(n=n(), mean=mean(MATHS), sd=sd(MATHS)) %>% mutate(se=sd/sqrt(n-1))
```

```{r}
knitr::kable(head(my_sum), format = 'html')
```

### 3.1 Plotting standard error bars of point estimates
```{r}
ggplot(my_sum) + geom_errorbar(aes(x=RACE, ymin=mean-se, ymax=mean+se), width=0.2, colour="black", alpha=0.9, linewidth=0.5) + geom_point(aes(x=RACE, y=mean), stat="identity", color="red", size = 1.5, alpha=1) + ggtitle("Standard error of mean maths score by rac")
```

### 3.2 Plotting confidence interval of point estimates
```{r}
ggplot(my_sum) + geom_errorbar(aes(x=reorder(RACE, -mean),    ymin=mean-1.96*se, ymax=mean+1.96*se), width=0.2, colour="black", alpha=0.9, linewidth=0.5) + geom_point(aes(x=RACE, y=mean),  stat="identity", color="red", size = 1.5, alpha=1) + labs(x = "Maths score", title = "95% confidence interval of mean maths score by race")
```

### 3.3 Visualizing the uncertainty of point estimates with interactive error bars
```{r}
shared_df = SharedData$new(my_sum)

bscols(widths = c(4,8), ggplotly((ggplot(shared_df) + geom_errorbar(aes(x=reorder(RACE, -mean), ymin=mean-2.58*se, ymax=mean+2.58*se), width=0.2, colour="black", alpha=0.9, size=0.5) + geom_point(aes(x=RACE, y=mean, text = paste("Race:", `RACE`, "<br>N:", `n`, "<br>Avg. Scores:", round(mean, digits = 2), "<br>95% CI:[", round((mean-2.58*se), digits = 2), ",", round((mean+2.58*se), digits = 2),"]")), stat="identity", color="red", size = 1.5, alpha=1) + xlab("Race") + ylab("Average Scores") + theme_minimal() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) + ggtitle("99% CI avg <br>maths scores")), tooltip = "text"), DT::datatable(shared_df, rownames = FALSE, class="compact", width="100%", options = list(pageLength = 10, scrollX=T), colnames = c("No. of pupils", "Avg Scores", "Std Dev", "Std Error")) %>% formatRound(columns=c('mean', 'sd', 'se'), digits=2))
```

## 4.0 Visualising Uncertainty: ggdist package

### 4.1 Visualizing the uncertainty of point estimates: ggdist methods
```{r}
exam %>% ggplot(aes(x = RACE, y = MATHS)) + stat_pointinterval() +
labs(title = "Visualising confidence intervals of mean math score",
subtitle = "Mean Point + Multiple-interval plot")
```

```{r}
exam %>% ggplot(aes(x = RACE, y = MATHS)) + stat_pointinterval(.width = 0.95, .point = median, .interval = qi) + labs(title = "Visualising confidence intervals of mean math score", subtitle = "Mean Point + Multiple-interval plot")
```

```{r}
exam %>% ggplot(aes(x = RACE, y = MATHS)) + stat_pointinterval(show.legend = FALSE) + labs(title = "Visualising confidence intervals of mean math score", subtitle = "Mean Point + Multiple-interval plot")
```

```{r}
exam %>% ggplot(aes(x = RACE, y = MATHS)) + stat_gradientinterval(fill = "skyblue", show.legend = FALSE) + labs(title = "Visualising confidence intervals of mean math score", subtitle = "Gradient + interval plot")
```

## 5.0 Visualising Uncertainty with Hypothetical Outcome Plots (HOPs)

### 5.1 Installing ungeviz package
```{r}
devtools::install_github("wilkelab/ungeviz")
```

### 5.2 Launch the application in R
```{r}
library(ungeviz)
```

### 5.3 Visualising Uncertainty with Hypothetical Outcome Plots (HOPs)
```{r}
ggplot(data = exam, (aes(x = factor(RACE), y = MATHS))) +  geom_point(position = position_jitter(height = 0.3, width = 0.05), 
size = 0.4, color = "#0072B2",  alpha = 1/2) + geom_hpline(data = sampler(25, group = RACE), height = 0.6, color = "#D55E00") + theme_bw() + transition_states(.draw, 1, 3)
```

# Lesson 4-D: Funnel Plots for Fair Comparisons

## 1.0 Getting Started

Install and launch the following R packages

```{r}
pacman::p_load(tidyverse, FunnelPlotR, plotly, knitr)
```

## 2.0 Data

Loading the data to the R environment by using read_csv() function of readr package

```{r}
covid19 <- read_csv("chap04/data/COVID-19_DKI_Jakarta.csv") %>% mutate_if(is.character, as.factor)
```

## 3.0 FunnelPlotR methods

### 3.1 FunnelPlotR methods: The basic plot

```{r}
funnel_plot(.data = covid19, numerator = Positive, denominator = Death, group = `Sub-district`)
```

### 3.2 FunnelPlotR methods: Makeover 1

```{r}
funnel_plot(.data = covid19, numerator = Death, denominator = Positive, group = `Sub-district`, data_type = "PR", #<< 
xrange = c(0, 6500),  #<<
yrange = c(0, 0.05)   #<<
)
```

### 3.3 FunnelPlotR methods: Makeover 2

```{r}
funnel_plot(.data = covid19, numerator = Death, denominator = Positive, group = `Sub-district`, data_type = "PR", xrange = c(0, 6500), yrange = c(0, 0.05), label = NA, title = "Cumulative COVID-19 Fatality Rate", #<<           
x_label = "Cumulative COVID-19 Positive Cases", #<<
y_label = "Cumulative Fatality Rate"  #<<
)
```

## 4.0 Funnel Plot for Fair Visual Comparison: ggplot2 methods
### 4.1 Computing the basic derived fields

```{r}
df <- covid19 %>% mutate(rate = Death / Positive) %>% mutate(rate.se = sqrt((rate*(1-rate)) / (Positive))) %>% filter(rate > 0)
```

```{r}
fit.mean <- weighted.mean(df$rate, 1/df$rate.se^2)
```

### 4.2 Calculate lower and upper limits for 95% and 99.9% CI

```{r}
number.seq <- seq(1, max(df$Positive), 1)
number.ll95 <- fit.mean - 1.96 * sqrt((fit.mean*(1-fit.mean)) / (number.seq)) 
number.ul95 <- fit.mean + 1.96 * sqrt((fit.mean*(1-fit.mean)) / (number.seq)) 
number.ll999 <- fit.mean - 3.29 * sqrt((fit.mean*(1-fit.mean)) / (number.seq)) 
number.ul999 <- fit.mean + 3.29 * sqrt((fit.mean*(1-fit.mean)) / (number.seq)) 
dfCI <- data.frame(number.ll95, number.ul95, number.ll999, 
                   number.ul999, number.seq, fit.mean)
```

### 4.3 Plotting a static funnel plot

```{r}
p <- ggplot(df, aes(x = Positive, y = rate)) + geom_point(aes(label=`Sub-district`), alpha=0.4) + geom_line(data = dfCI, aes(x = number.seq, y = number.ll95), size = 0.4, colour = "grey40", linetype = "dashed") + geom_line(data = dfCI, aes(x = number.seq, y = number.ul95), size = 0.4, colour = "grey40", linetype = "dashed") + geom_line(data = dfCI,  aes(x = number.seq, 
y = number.ll999), size = 0.4, colour = "grey40") + geom_line(data = dfCI, aes(x = number.seq, y = number.ul999), size = 0.4, colour = "grey40") + geom_hline(data = dfCI, aes(yintercept = fit.mean), size = 0.4, colour = "grey40") + coord_cartesian(ylim=c(0,0.05)) +
 annotate("text", x = 1, y = -0.13, label = "95%", size = 3, colour = "grey40") +  annotate("text", x = 4.5, y = -0.18, label = "99%", size = 3, colour = "grey40") +  ggtitle("Cumulative Fatality Rate by Cumulative Number of COVID-19 Cases") + xlab("Cumulative Number of COVID-19 Cases") + ylab("Cumulative Fatality Rate") + theme_light() + theme(plot.title = element_text(size=12), legend.position = c(0.91,0.85), legend.title = element_text(size=7), legend.text = element_text(size=7), legend.background = element_rect(colour = "grey60", linetype = "dotted"), legend.key.height = unit(0.3, "cm"))
p
```

### 4.4 Interactive Funnel Plot: plotly + ggplot2

```{r}
fp_ggplotly <- ggplotly(p,tooltip = c("label", "x", "y"))
fp_ggplotly
```